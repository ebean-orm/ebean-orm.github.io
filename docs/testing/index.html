<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta id="layout-head" />
    <title>Introduction</title>
    <link rel="shortcut icon" href="/images/favicon.ico" >
    <!--<link href="/css/bootstrap.min.css" rel="stylesheet">-->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="/css/site.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
  <div id="wrap">
    <div id="header">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".mobile-nav">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><img src="/images/logo-black-3.png" width="32" style="display: inline;">Ebean ORM</a>
        </div>
        <div class="collapse navbar-collapse">
<ul class="nav navbar-nav pull-right">
  <li ><a href="/"><span class="glyphicon glyphicon-home"></span>  Home</a></li>
  <li ><a href="/videos">Videos</a></li>
  <li ><a href="/quickstart">Quick Start</a></li>
  <li ><a href="/support">Support</a></li>
  <li ><a href="/docs">Docs</a></li>
  <li ><a target="_blank" href="/apidoc/10">ApiDocs</a></li>
  <li ><a href="/releases">Releases</a></li>
  <li ><a target="_blank" href="https://github.com/ebean-orm/ebean"> <i class="fa fa-github"></i> Github</a></li>
</ul>        </div>
        <div class="mobile-nav">
<ul class="nav navbar-nav pull-right">
  <li ><a href="/"><span class="glyphicon glyphicon-home"></span>  Home</a></li>
  <li ><a href="/videos">Videos</a></li>
  <li ><a href="/quickstart">Quick Start</a></li>
  <li ><a href="/support">Support</a></li>
  <li ><a href="/docs">Docs</a></li>
  <li ><a target="_blank" href="/apidoc/10">ApiDocs</a></li>
  <li ><a href="/releases">Releases</a></li>
  <li ><a target="_blank" href="https://github.com/ebean-orm/ebean"> <i class="fa fa-github"></i> Github</a></li>
</ul>        </div>
      </div>
    </div>

  </div>
  <div id="main">

<div class="jumbotron mini">
  <div class="container">
    <h1><a href="/docs/">Documentation</a> / Testing</h1>
  </div>
</div>

<div class="container doc-index bs-docs-container">

  <div class="row">

    <div class="col-md-9" role="main">

      <form action="https://www.google.com/search" method="get">
        <div class="page-inline-search" style="margin-bottom:8px;">
          <div class="input-group">
            <input name="q" id="searchinput" type="text" class="form-control" placeholder="Search... (press 's' to focus)" data-placeholder-focus="Search... (use '↑', '↓' and '⏎' to select results)" data-placeholder-blur="Search... (press 's' to focus)" autocomplete="off">
            <input type="hidden" name="as_sitesearch" value="ebean-orm.github.io">
            <div class="input-group-btn">
              <button class="btn btn-default form-control" type="submit"><i class="glyphicon glyphicon-search"></i></button>
            </div>
          </div>
          <div class="search-results-inline-container" style="display: none;">
            <ul id="search-results-container" class="search-results"><li class=" active"><a href="/docs" title="Docs"><span style="color:#777;">Docs</span> Documentation </a></li><li class=""><small style="color:#999;">And 101 more...</small></li></ul>
          </div>
        </div>
      </form>

      

<h3><a id="quickstart">Testing Quickstart</a></h3>
<h4>1. Add ebean-test-config as a test dependency</h4>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.ebean.test<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>ebean-test-config<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>11.18.2<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>



<h4>2. Add application-test.yml</h4>
<p>
  Add into <code>src/test/resources</code> a <code>application-test.yml</code> configuration file
  that we use for testing.
</p>
<div class="syntax sh"><div class="highlight"><pre><span></span>ebean:
  test:
    platform: h2 <span class="c1">#, h2, postgres, mysql, oracle, sqlserver</span>
    ddlMode: dropCreate <span class="c1"># none | dropCreate | create | migration | createOnly | migrationDropCreate</span>
    dbName: myapp
</pre></div>
</div>
<p>
  We can modify this test configuration to control what DDL is executed (create-all.sql or migrations)
  and the database platform we want to test against (potentially using docker).
</p>
<p>
  ebean-test-config will take care of:
</p>
<ul>
  <li>Properties to control DDL generation and execution</li>
  <li>Docker container setup and execution based on the database platform</li>
  <li>JDBC Datasource properties (matching the database docker container)</li>
  <li>Register a current user and tenant provider if not already specified (to ease testing with @Who properties etc)</li>
</ul>

<h3><a id="ddlmode">ddlMode</a></h3>
<table class="table">
  <tr>
    <th>Mode</th>
    <th>Description</th>
  </tr>
  <tr>
    <td>dropCreate</td>
    <td>Drop and then create all the tables etc. Most commonly used mode.</td>
  </tr>
  <tr>
    <td>none</td>
    <td>Do not run any DDL. Useful if we want to run 1 particular test without any DDL change.</td>
  </tr>
  <tr>
    <td>migration</td>
    <td>Run the DB migration. Good for testing migrations run as expected.</td>
  </tr>
  <tr>
    <td>migrationDropCreate</td>
    <td>Run the DB migration but first delete the database first ensuring the migration runs against a new database.</td>
  </tr>
  <tr>
    <td>create</td>
    <td>Run the create-all.sql DDL script but delete and recreate the database first.</td>
  </tr>
  <tr>
    <td>createOnly</td>
    <td>Run the create-all.sql DDL script but without recreating the database first.</td>
  </tr>
</table>


<h3><a id="platform">platform</a></h3>
<table class="table">
  <tr>
    <th>Platform</th>
    <th>Description</th>
  </tr>
  <tr>
    <td>h2</td>
    <td>Run using in-memory H2 database.
      <dl>
        <dd><b>url:</b> jdbc:h2:mem:{databaseName}</dd>
        <dd><b>driver:</b> org.h2.Driver</dd>
      </dl>
    </td>
  </tr>
  <tr>
    <td>postgres</td>
    <td>Run against Postgres docker DB.
      <dl>
        <dd><b>port:</b> 6432</dd>
        <dd><b>password:</b> test</dd>
        <dd><b>url:</b> jdbc:postgresql://localhost:{port}/{databaseName}</dd>
        <dd><b>driver:</b> org.postgresql.Driver</dd>
        <dd><b>image:</b> postgres:{version}</dd>
      </dl>
    </td>
  </tr>
  <tr>
    <td>mysql</td>
    <td>Run against MySql docker DB.
      <dl>
        <dd><b>port:</b> 4306</dd>
        <dd><b>password:</b> test</dd>
        <dd><b>url:</b> jdbc:mysql://localhost:{port}/{databaseName}</dd>
        <dd><b>driver:</b> com.mysql.jdbc.Driver</dd>
        <dd><b>image:</b> mysql:{version}</dd>
      </dl>
    </td>
  </tr>
  <tr>
    <td>sqlserver</td>
    <td>Run against SqlServer docker DB with the following defaults.
      <dl>
        <dd><b>port:</b> 1433</dd>
        <dd><b>password:</b> SqlS3rv#r</dd>
        <dd><b>url:</b> jdbc:sqlserver://localhost:{port};databaseName={databaseName}</dd>
        <dd><b>driver:</b> com.microsoft.sqlserver.jdbc.SQLServerDriver</dd>
        <dd><b>image:</b> microsoft/mssql-server-linux:{version}</dd>
      </dl>
    </td>
  </tr>
  <tr>
    <td>oracle</td>
    <td>Run against Oracle docker DB.
      <dl>
        <dd><b>port:</b> 1521</dd>
        <dd><b>password:</b> test</dd>
        <dd><b>url:</b> jdbc:oracle:thin:@localhost:{port}:XE</dd>
        <dd><b>driver:</b> oracle.jdbc.driver.OracleDriver</dd>
        <dd><b>image:</b> sath89/oracle-12c:{version}</dd>
      </dl>
    </td>
  </tr>
  <tr>
    <td>sqlite</td>
    <td>Run using Sqlite database.
      <dl>
        <dd><b>url:</b> jdbc:sqlite:{databaseName}</dd>
        <dd><b>driver:</b> org.sqlite.JDBC</dd>
        <dd><b>isolationlevel:</b> read_uncommitted</dd>
      </dl>
    </td>
  </tr>
</table>

<h3><a id="docker">Docker / ebean-test-docker</a></h3>
<p>
  For all the platforms apart from H2 and Sqlite this will automatically:
</p>
<ul>
  <li>Start a docker container (if necessary)</li>
  <li>Wait for the container to be ready</li>
  <li>Create the database and user setting any permissions as necessary</li>
  <li>When ready allow the tests to run</li>
</ul>
<p>
  We can see/review what is occurring by increasing the logging for <code>io.ebean.docker</code> to <code>TRACE</code>.
  When we do that we can see log messages like:
</p>
<div class="syntax sh"><div class="highlight"><pre><span></span>15:15:02.232 <span class="o">[</span>main<span class="o">]</span> INFO  io.ebean.EbeanVersion - ebean version: 11.18.2


<span class="c1">## PROPERTIES FILE(S)</span>

15:15:02.284 <span class="o">[</span>main<span class="o">]</span> INFO  i.e.config.properties.LoadContext - loaded properties from <span class="o">[</span>application.yml, application-test.yml<span class="o">]</span>


<span class="c1">## DOCKER COMMANDS</span>

15:15:02.537 INFO  io.ebean.docker.commands.Commands - Container ut_postgres running with port:6432 db:test_ex user:test_ex mode:Create shutdown:
15:15:02.538 DEBUG io.ebean.docker.commands.Commands - docker <span class="nb">exec</span> -i ut_postgres pg_isready -h localhost -p 5432
15:15:02.645 DEBUG io.ebean.docker.commands.Commands - docker <span class="nb">exec</span> -i ut_postgres psql -U postgres -c <span class="k">select</span> datname from pg_database
15:15:02.753 DEBUG io.ebean.docker.commands.Commands - docker <span class="nb">exec</span> -i ut_postgres psql -U postgres -c <span class="k">select</span> rolname from pg_roles where <span class="nv">rolname</span> <span class="o">=</span> <span class="s1">&#39;test_ex&#39;</span>
15:15:02.871 DEBUG io.ebean.docker.commands.Commands - docker <span class="nb">exec</span> -i ut_postgres psql -U postgres -c <span class="k">select</span> <span class="m">1</span> from pg_database where <span class="nv">datname</span> <span class="o">=</span> <span class="s1">&#39;test_ex&#39;</span>
15:15:02.960 DEBUG io.ebean.docker.commands.Commands - create database extensions hstore,pgcrypto
15:15:02.960 DEBUG io.ebean.docker.commands.Commands - docker <span class="nb">exec</span> -i ut_postgres psql -U postgres -d test_ex -c create extension <span class="k">if</span> not exists hstore
15:15:03.058 DEBUG io.ebean.docker.commands.Commands - docker <span class="nb">exec</span> -i ut_postgres psql -U postgres -d test_ex -c create extension <span class="k">if</span> not exists pgcrypto
15:15:03.143 DEBUG io.ebean.docker.commands.Commands - waitForConnectivity ut_postgres ...
15:15:03.143 DEBUG io.ebean.docker.commands.Commands - checkConnectivity on ut_postgres ...
15:15:03.190 DEBUG io.ebean.docker.commands.Commands - connectivity confirmed <span class="k">for</span> ut_postgres
15:15:03.190 DEBUG io.ebean.docker.commands.Commands - Container ut_postgres ready with port 6432


<span class="c1">## FOR TESTING ... set a current user and tenant provider</span>

15:15:03.194 <span class="o">[</span>main<span class="o">]</span> INFO  i.e.t.c.provider.ProviderAutoConfig - <span class="k">for</span> testing purposes a current user and tenant provider has been configured. Use io.ebean.test.UserContext to <span class="nb">set</span> current user and tenant in tests.


<span class="c1">## SELECTED PLATFORM</span>

15:15:03.239 <span class="o">[</span>main<span class="o">]</span> INFO  o.a.datasource.pool.ConnectionPool - DataSourcePool <span class="o">[</span>db<span class="o">]</span> autoCommit<span class="o">[</span>false<span class="o">]</span> transIsolation<span class="o">[</span>READ_COMMITTED<span class="o">]</span> min<span class="o">[</span>2<span class="o">]</span> max<span class="o">[</span>200<span class="o">]</span>
15:15:03.277 <span class="o">[</span>main<span class="o">]</span> INFO  io.ebean.internal.DefaultContainer - DatabasePlatform name:db platform:postgres


<span class="c1">## EXECUTE DDL</span>

15:15:03.618 <span class="o">[</span>main<span class="o">]</span> INFO  io.ebean.DDL - Executing extra-dll - <span class="m">0</span> statements
15:15:03.618 <span class="o">[</span>main<span class="o">]</span> INFO  io.ebean.DDL - Executing db-drop-all.sql - <span class="m">26</span> statements
15:15:03.649 <span class="o">[</span>main<span class="o">]</span> DEBUG io.ebean.DDL - executing <span class="m">1</span> of <span class="m">26</span> alter table <span class="k">if</span> exists address drop constraint <span class="k">if</span> exists fk_address_country_code
15:15:03.651 <span class="o">[</span>main<span class="o">]</span> DEBUG io.ebean.DDL - executing <span class="m">2</span> of <span class="m">26</span> drop index <span class="k">if</span> exists ix_address_country_code
...
15:15:03.701 <span class="o">[</span>main<span class="o">]</span> INFO  io.ebean.DDL - Executing db-create-all.sql - <span class="m">28</span> statements
15:15:03.701 <span class="o">[</span>main<span class="o">]</span> DEBUG io.ebean.DDL - executing <span class="m">1</span> of <span class="m">28</span> create table address <span class="o">(</span> id                            bigserial not null, line1...
15:15:03.709 <span class="o">[</span>main<span class="o">]</span> DEBUG io.ebean.DDL - executing <span class="m">2</span> of <span class="m">28</span> create table contact <span class="o">(</span> id                            bigserial not null, first_n...
...
15:15:03.841 <span class="o">[</span>main<span class="o">]</span> INFO  io.ebean.DDL - Executing extra-dll - <span class="m">1</span> statements
15:15:03.842 <span class="o">[</span>main<span class="o">]</span> DEBUG io.ebean.DDL - executing <span class="m">1</span> of <span class="m">1</span> create or replace view order_agg_vw as <span class="k">select</span> d.order_id as id, d.order_id as or...
</pre></div>
</div>

<h3><a id="startup">Container startup</a></h3>
<p>
  To startup the docker containers we hook into the Ebean lifecycle. This means that it will "just work" whether
  the tests are run from the IDE, maven, gradle or any build tool. In prior iterations the startup of docker
  containers was hooked specifically into the maven lifecycle but this proved to be less than ideal.
</p>
<p>
  In general this is providing a similar experience to the one we have when using H2 database. That is, we bring up
  the database (if needed), setup the database, user, roles etc (if needed) get it ready for testing by running DDL
  ... and then run all tests.
</p>

<h3><a id="shutdown">Container shutdown</a></h3>
<p>
  On developer machines we generally keep the docker container running. On a CI server we may want to stop the
  docker container after running all the tests. To do this we set <code>shutdown</code> to either
  <code>stop</code> (to just stop the container) or <code>remove</code> (to stop and remove the container).
</p>
<div class="syntax sh"><div class="highlight"><pre><span></span>ebean:
  test:
    shutdown: stop  <span class="c1"># stop | remove</span>
    platform: postgres <span class="c1"># h2, postgres, mysql, oracle, sqlserver</span>
    ddlMode: dropCreate <span class="c1"># none | dropCreate | create | migration | createOnly | migrationDropCreate</span>
    dbName: myapp
</pre></div>
</div>

<h3><a id="not-docker">Not using Docker</a></h3>
<p>
  If we don't want to start and run a Docker container but instead test against some other existing database we can
  do that via setting <code>useDocker: false</code>.
</p>
<p>
  The below configuration runs against an existing Postgres database. Typically when not using docker we need to
  set the username, password and url to appropriate values.
</p>
<p>
  When we are using  <code>useDocker: false</code> the database and user are expected to already exist along with
  permissions (and Postgres extension).
</p>
<div class="syntax sh"><div class="highlight"><pre><span></span>ebean:
  test:
    useDocker: <span class="nb">false</span>  <span class="c1">## DO NOT USE DOCKER</span>
    platform: postgres <span class="c1"># h2, postgres, mysql, oracle, sqlserver</span>
    ddlMode: dropCreate <span class="c1"># none | dropCreate | create | migration | createOnly | migrationDropCreate</span>
    dbName: <span class="nb">test</span>
    postgres:
      username: <span class="nb">test</span>
      password: <span class="nb">test</span>
      url: jdbc:postgresql://localhost:5432/test
</pre></div>
</div>


<h3><a id="current-user">Current User and Tenant Providers</a></h3>
<p>
  ebean-test-config will automatically register a <code>current user provider</code> and a <code>current tenant provider</code>.
  These are only set if you don't set them yourself.
</p>
<p>
  What this means is that without doing anything we can use <code>@WhoCreated / @WhoModified</code> in tests and via
  <code>io.ebean.test.UserContext</code> we can set current user and tenant in tests.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// set the current userId which will be put</span>
<span class="c1">// into &#39;WhoCreated&#39; and &#39;WhoModified&#39; properties</span>

<span class="n">UserContext</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="s">&quot;U1&quot;</span><span class="o">);</span>
</pre></div>
</div>


<div class="next pull-right">
  <a href="/docs/testing/test-properties" class="btn btn-info">Next: Test properties</a>
</div>


    </div>

    <div class="col-md-3" role="complementary">
      <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm">
        <ul class="nav bs-docs-sidenav">

<li class="active">
  <a href="/docs/testing">Quickstart</a>
<ul class="nav">
  <li><a href="#ddlmode">DDL Mode</a></li>
  <li><a href="#platform">Platform</a></li>
  <li><a href="#docker">Docker</a></li>
  <li><a href="#startup">Startup</a></li>
  <li><a href="#shutdown">Shutdown</a></li>
  <li><a href="#not-docker">Not Docker</a></li>
  <li><a href="#current-user">Current User</a></li>
</ul>
</li>
<li >
  <a href="/docs/testing/test-properties">Test properties</a>
</li>
<li >
  <a href="/docs/testing/elasticsearch">ElasticSearch</a>
</li>
<li >
  <a href="/docs/testing/postgres">Postgres</a>
</li>
<li >
  <a href="/docs/testing/sqlserver">SQL Server</a>
</li>
<li >
  <a href="/docs/testing/mocki">Mocki Ebean</a>
</li>
        </ul>
      </nav>
    </div>
  </div>

</div>


  </div>
  </div>

<footer id="footer">
  <div class="doc-footer">
    <ul class="doc-footer-links">
      <li><a href="/">Ebean ORM</a></li>
      <li> | </li>
      <li><a href="http://avaje-metric.github.io">Metrics</a></li>
    </ul>
  </div>
</footer>

  <script type="text/javascript">
    var categoryNames = {};
  </script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.3/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/jquery.easing.min.js"></script>

    <script src="/js/json2.js"></script>
  <script src="/js/jquery.cookie.min.js"></script>
  <script src="/js/jquery.storageapi.min.js"></script>
  <script src="/js/ebean-site.js"></script>
  <script src="/js/extra.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-75181644-1', 'auto');
    ga('send', 'pageview');

  </script>
  <!-- at the end of the BODY -->
  </body>
</html>
