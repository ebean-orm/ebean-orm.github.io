<!doctype html>
<html lang="en">
<head>
  <title>EmbeddedId | Interesting ... | Ebean</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Sans+Pro|Ubuntu&display=swap">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/reset3.css">
  <link rel="stylesheet" href="/css/site3.css">
  <link rel="stylesheet" href="/css/pygments3.css">
</head>
<body>
<div id="main">
  
<div id="banner">
  <header>
    <nav id="top">
      <h1 id="breadcrumb">
        <a class="nav-logo" href="/"><img src="/images/logo-200.png" height="35"></a>&nbsp;&nbsp;<a href="/docs">Documentation</a><span class="sep">&nbsp;/&nbsp;</span><a href="/docs/well-thats-interesting/">Interesting ...</a><span class="sep">&nbsp;/&nbsp;</span><span class="last">EmbeddedId and record type</span>
      </h1>
      <ul>
        <li><a href="https://github.com/ebean-orm/ebean" title="github source"><i class="fab fa-github"></i></a></li>
        <li><a onclick="toggleTheme();" title="switch dark light theme"><i class="fas fa-adjust"></i></a></li>
      </ul>
    </nav>
  </header>
</div>
<div class="grid grid-docs">
  <aside>
<nav class="side">
  <ul>
      <li class="nav0 ">
    <a  href="/docs/getting-started">Getting started</a>
  </li>
  <li class="nav0 ">
    <a  href="/docs/intro">Introduction</a>
  </li>
  <li class="nav0 ">
    <a  href="/docs">Documentation</a>
  </li>
  <li class="nav0 ">
    <a  href="/support">Getting help</a>
  </li>
    <li class="nav0 ">
      <a target="_blank" href="/apidoc/13">API Javadoc</a>
    </li>
  <li class="nav0 ">
    <a  href="/videos">Videos</a>
  </li>
  <li class="nav0 ">
    <a  href="/docs/upgrading">Upgrading</a>
  </li>
  <li class="nav0 ">
    <a  href="/releases">Releases</a>
  </li>

  </ul>
</nav>
  </aside>
  <article>
<form action="https://www.google.com/search" method="get" class="inline-form">
  <input type="hidden" name="as_sitesearch" value="ebean.io">
  <div id="page-search">
    <div class="input-group">
      <input class="frm" name="q" id="searchinput" type="text" placeholder="Search... (press 's' to focus)" data-placeholder-focus="Search... (use '↑', '↓' and '⏎' to select results)" data-placeholder-blur="Search... (press 's' to focus)" autocomplete="off">
      <div class="input-group-btn">
        <button class="frm" type="submit"><i class="fas fa-search"></i></button>
      </div>
    </div>
    <div id="page-search-results" style="display: none;">
      <ul id="search-results-container" class="search-results"><li class=" active"><a href="/docs" title="Docs"><span style="color:#777;">Docs</span> Documentation </a></li><li class=""><small style="color:#999;">And 101 more...</small></li></ul>
    </div>
  </div>
</form>
    
<h2>Mapping concatenated primary keys</h2>
<p>
  JPA and Ebean use <code>@EmbeddedId</code> or <code>@IdClass</code> to map concatenated primary keys.
  For both these cases the Primary key is modeled as an <code>@Embeddable</code>.
</p>
<p>
  In the example below, the primary key is made up of <code>partId</code> and <code>brandId</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PartBrandKey</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">partId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">brandId</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">PartBrandKey</span><span class="o">(</span><span class="kt">long</span> <span class="n">partId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">brandId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">partId</span> <span class="o">=</span> <span class="n">partId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">brandId</span> <span class="o">=</span> <span class="n">brandId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">partId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">partId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">brandId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">brandId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">PartBrandKey</span> <span class="n">that</span> <span class="o">=</span> <span class="o">(</span><span class="n">PartBrandKey</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">partId</span> <span class="o">==</span> <span class="n">that</span><span class="o">.</span><span class="na">partId</span> <span class="o">&amp;&amp;</span> <span class="n">brandId</span> <span class="o">==</span> <span class="n">that</span><span class="o">.</span><span class="na">brandId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">partId</span><span class="o">,</span> <span class="n">brandId</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
  The semantics of an <code>@Embeddable</code> that maps a primary key is that the <code>equals</code> and
  <code>hashCode</code> <em><b>must include all the components</b></em> - in this case both partId and brandId <em>MUST</em>
  be part of the equals and hashCode implementation.
</p>
<p>
  We see semantics that match an immutable type.
</p>
<p>
  Note that the ORM requires developers to provide the correct implementation of equals and hashCode. It is on
  the <em>developer</em> to do this correctly - not the ORM (most will get the IDE to generate these).
  If the developer stuffs this up things will go bang!!! but this is NOT on the ORM.
</p>
<p>
  Now the above works for Ebean but if we consider 3 JPA implementations then we note that 2 of those
  currently require a default constructor (which can be private). The above does not exactly work for
  those ORMs and we instead for those ORMs we need to add a [private] default constructor.
</p>

<h2>Adding a default constructor</h2>
<p>
  Adding a [private] default constructor is required by some ORMs. What we <em>then</em> see is:
</p>
<ul>
  <li>The fields are no longer final</li>
  <li>We have a private constructor that doesn't look like its used - it will be used by the ORM</li>
  <li>The class is now 'effectively immutable' rather than strictly immutable (internally the ORM is going to use
    that private constructor, set the values, then hand off the fully populated effective immutable instance)</li>
</ul>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PartBrandKey</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kt">long</span> <span class="n">partId</span><span class="o">;</span>         <span class="cm">/** no longer final */</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">brandId</span><span class="o">;</span>        <span class="cm">/** no longer final */</span>

  <span class="kd">private</span> <span class="nf">PartBrandKey</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>   <span class="cm">/** for ORM use only */</span>

  <span class="kd">public</span> <span class="nf">PartBrandKey</span><span class="o">(</span><span class="kt">long</span> <span class="n">partId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">brandId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">partId</span> <span class="o">=</span> <span class="n">partId</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">brandId</span> <span class="o">=</span> <span class="n">brandId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">partId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">partId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">brandId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">brandId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">PartBrandKey</span> <span class="n">that</span> <span class="o">=</span> <span class="o">(</span><span class="n">PartBrandKey</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">partId</span> <span class="o">==</span> <span class="n">that</span><span class="o">.</span><span class="na">partId</span> <span class="o">&amp;&amp;</span> <span class="n">brandId</span> <span class="o">==</span> <span class="n">that</span><span class="o">.</span><span class="na">brandId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">partId</span><span class="o">,</span> <span class="n">brandId</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>



<h2>Enter Record type ...</h2>
<p>
  What ORMs want to do for this case is:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="n">record</span> <span class="nf">PartBrandKey</span><span class="o">(</span><span class="kt">long</span> <span class="n">partId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">brandId</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</pre></div>
</div>
<p>
  When we look at the semantics of <code>record</code> type we see it's a match for what we are trying to
  do for this case of mapping a concatenated primary key with <code>@Embeddable</code>. We see an immutable
  type and the semantics of <code>Record::equals()</code> is an exact match.
</p>
<p>
  From an ORM perspective the above looks perfect and we have an exact match in semantics.
</p>

<h2>Enter Kotlin data class ...</h2>
<p>
  The Kotlin folks are going to point out this is also a match to a <code>data class</code> with <code>val</code>
  parameters.
</p>
<div class="syntax kotlin"><div class="highlight"><pre><span></span><span class="nd">@Embeddable</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">PartBrandKey</span><span class="p">(</span><span class="k">val</span> <span class="py">partId</span><span class="p">:</span> <span class="n">Long</span><span class="p">,</span> <span class="k">val</span> <span class="py">brandId</span><span class="p">:</span> <span class="n">Long</span><span class="p">)</span>
</pre></div>
</div>



<h2>The world between javac and the jvm</h2>
<p>
  Bytecode transformation lives in that world between javac and the jvm. Generally we have an
  annotation like <em>@Embeddable</em> or <em>@Transactional</em> as a marker for the bytecode
  transformation to be applied to that class or method.
</p>
<p>
  Bytecode transformation reads and transforms bytecode so in this sense it doesn't necessarily
  even see "language features" per say. For example, ebean bytecode transformation applies equally
  to other JVM languages like Kotlin, Scala, Groovy.
</p>
<p>
  In this way the bytecode created by record type presented nothing new to ebean-agent (the ebean bytecode
  transformer) in much the same way a kotlin data class didn't look new.
</p>
<p>
  Yes Java records are different in that they extend <code>java.lang.Record</code>, yes they are different in
  how they provide a default implementation of hashCode and equals using <code>java.lang.runtime.ObjectMethods</code>
  and method handles (which is actually pretty cool) but for ebean-agent in terms of the transforms it
  is expected to make, the bytecode presented by record types isn't really new or different when compared to
  the plain old non-record cases or indeed kotlin data classes.
</p>
<p>
  From an ebean perspective that is expected because - record type is a <em>language</em> feature and the
  ebean-agent reads bytecode and is really not <em>expected</em> to see <em>language</em> features.
</p>


<!--
<h2>Side note on Meta Programming</h2>
<p>
  Meta programming is hugely important to ORM in general and for ORMs on the JVM bytecode transformation
  (aka javaagent / java.lang.instrument / instrumentation / enhancement / AOP) is a key tool we use to apply
  ORM semantics onto classes annotated with <code>@Entity</code> and <code>@Embeddable</code> etc.
</p>
<p>
  The value proposition around ORM bytecode transformation is that the semantics that are applied to support
  features like dirty state, dirty checking, lazy loading, partial objects is worth it relative to the "magical-ness"
  of it.
</p>
<p>
  To a large extent we need to do a much better job at explaining what these ORM semantics are and why we deem
  them important (TLDR: to optimise our interaction with the database) and why we use bytecode transformation
  in particular to do this job.
</p>
-->



  </article>
</div>

</div>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="/js/site3.js"></script>
<script src="/js/search3.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-75181644-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-75181644-1');
</script>
</body>
</html>
